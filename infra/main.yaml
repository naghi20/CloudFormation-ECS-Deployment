AWSTemplateFormatVersion: '2010-09-09'
Description: Main CloudFormation Stack Orchestrator

Parameters:
  ECRImageUri:
    Type: String
    Description: ECR Repository URI for the Docker image
  TemplatesBucket:
    Type: String
    Description: S3 Bucket name where CloudFormation templates are stored

Resources:
  # VPC Stack
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/vpc/vpc.yaml'

  # Internet Gateway Stack
  IGWStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/vpc/igw.yaml'
      Parameters:
        VpcStackName: !GetAtt VPCStack.StackName

  # Subnets Stack
  SubnetsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/vpc/subnets.yaml'
      Parameters:
        VpcStackName: !GetAtt VPCStack.StackName

  # Route Table Stack
  RouteTableStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - VPCStack
      - SubnetsStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/vpc/route-table.yaml'
      Parameters:
        VpcStackName: !GetAtt VPCStack.StackName
        SubnetsStackName: !GetAtt SubnetsStack.StackName

  # Route Stack
  RouteStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - IGWStack
      - RouteTableStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/vpc/route.yaml'
      Parameters:
        RouteTableStackName: !GetAtt RouteTableStack.StackName
        IGWStackName: !GetAtt IGWStack.StackName

  # ALB Security Group Stack
  ALBSGStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/security/alb-sg.yaml'
      Parameters:
        VpcStackName: !GetAtt VPCStack.StackName

  # ECS Security Group Stack
  ECSSGStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - VPCStack
      - ALBSGStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/security/ecs-sg.yaml'
      Parameters:
        VpcStackName: !GetAtt VPCStack.StackName
        ALBSGStackName: !GetAtt ALBSGStack.StackName

  # ECR Stack
  ECRStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/ecr.yaml'

  # Logs Stack
  LogsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/logs.yaml'

  # IAM Stack
  IAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/iam.yaml'

  # Cluster Stack
  ClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/cluster.yaml'

  # ALB Stack
  ALBStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - SubnetsStack
      - ALBSGStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/alb.yaml'
      Parameters:
        SubnetsStackName: !GetAtt SubnetsStack.StackName
        ALBSGStackName: !GetAtt ALBSGStack.StackName

  # Target Group Stack
  TargetGroupStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/target-group.yaml'
      Parameters:
        VpcStackName: !GetAtt VPCStack.StackName

  # Task Definition Stack
  TaskDefStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECRStack
      - LogsStack
      - IAMStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/taskdef.yaml'
      Parameters:
        ECRRepoUri: !Ref ECRImageUri
        LogGroupStackName: !GetAtt LogsStack.StackName
        IAMStackName: !GetAtt IAMStack.StackName

  # ECS Service Stack
  ServiceStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ClusterStack
      - TaskDefStack
      - TargetGroupStack
      - SubnetsStack
      - ECSSGStack
    Properties:
      TemplateURL: !Sub 'https://s3.${AWS::Region}.amazonaws.com/${TemplatesBucket}/templates/ecs/service.yaml'
      Parameters:
        ClusterStackName: !GetAtt ClusterStack.StackName
        TaskDefStackName: !GetAtt TaskDefStack.StackName
        TargetGroupStackName: !GetAtt TargetGroupStack.StackName
        SubnetsStackName: !GetAtt SubnetsStack.StackName
        ECSSecurityGroupStackName: !GetAtt ECSSGStack.StackName

Outputs:
  ALBDNSName:
    Description: ALB DNS Name
    Value: !GetAtt ALBStack.Outputs.ALBDNSName
    Export:
      Name: cicd-ecr-alb-dns
  ECRRepositoryUri:
    Description: ECR Repository URI
    Value: !GetAtt ECRStack.Outputs.ECRRepositoryUri
    Export:
      Name: cicd-ecr-repo-uri
  ServiceName:
    Description: ECS Service Name
    Value: !GetAtt ServiceStack.Outputs.ServiceName
    Export:
      Name: cicd-ecr-service-name
